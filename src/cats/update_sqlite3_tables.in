#!/bin/sh
#
# Shell script to update SQLite3 tables from Bacula Community version 5.2.x to 5.4.x
#
echo " "
echo "This script will update a Bacula PostgreSQL database from version 14 to 15"
echo "  which is needed to convert from Bacula Community version 5.2.x to 5.4.x"
echo " "

bindir=@SQLITE_BINDIR@
PATH="$bindir:$PATH"
cd @working_dir@
db_name=@db_name@

DBVERSION=`sqlite3 ${db_name}.db <<END
select VersionId from Version;
END
`
if [ $DBVERSION != 14 ] ; then
   echo " "
   echo "The existing database is version $DBVERSION !!"
   echo "This script can only update an existing version 14 database to version 15."
   echo "Error. Cannot upgrade this database."
   echo " "
   exit 1
fi

sqlite3 $* ${db_name}.db <<END-OF-DATA
BEGIN;

CREATE TABLE Quota (
   ClientId INTEGER REFERENCES Client DEFAULT 0,
   GraceTime INTEGER UNSIGNED DEFAULT 0,
   QuotaLimit BIGINT UNSIGNED DEFAULT 0,
   PRIMARY KEY (ClientId)
);

CREATE TABLE NDMPLevelMap (
   ClientId INTEGER REFERENCES Client DEFAULT 0,
   FileSetId INTEGER UNSIGNED REFERENCES FileSet DEFAULT 0,
   FileSystem TEXT DEFAULT '',
   DumpLevel INTEGER UNSIGNED DEFAULT 0,
   CONSTRAINT NDMPLevelMap_pkey PRIMARY KEY (ClientId, FilesetId, FileSystem)
);

ALTER TABLE Media ADD COLUMN EncryptionKey VARCHAR(128);

UPDATE Version SET VersionId=15;
COMMIT;

END-OF-DATA
