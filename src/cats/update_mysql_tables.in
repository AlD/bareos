#!/bin/sh
#
# Shell script to update MySQL Community version 5.2.x to 5.4.x
#
echo " "
echo "This script will update a Bacula MySQL database from version 14 to 15"
echo " which is needed to convert from Bacula Community version 5.2.x to 5.4.x"
echo " "
bindir=@MYSQL_BINDIR@
PATH="$bindir:$PATH"
db_name=${db_name:-@db_name@}

mysql -D ${db_name} $* -e "select VersionId from Version\G" >/tmp/$$
DBVERSION=`sed -n -e 's/^VersionId: \(.*\)$/\1/p' /tmp/$$`
if [ $DBVERSION != 14 ] ; then
   echo " "
   echo "The existing database is version $DBVERSION !!"
   echo "This script can only update an existing version 14 database to version 15."
   echo "Error. Cannot upgrade this database."
   echo " "
   exit 1
fi

if mysql -D ${db_name} $* -f <<END-OF-DATA
CREATE TABLE Quota (
   ClientId INT UNSIGNED DEFAULT NULL,
   GraceTime BIGINT DEFAULT 0,
   QuotaLimit BIGINT UNSIGNED DEFAULT 0,
   PRIMARY KEY (ClientId)
);

CREATE TABLE NDMPLevelMap (
   ClientId INTEGER DEFAULT 0 REFERENCES Client,
   FileSetId INTEGER UNSIGNED DEFAULT 0 REFERENCES FileSet,
   FileSystem TINYBLOB NOT NULL,
   PathId integer NOT NULL,
   CONSTRAINT NDMPLevelMap_pkey PRIMARY KEY (ClientId, FilesetId, FileSystem(256))
);

ALTER TABLE Media DROP COLUMN VolParts;
ALTER TABLE Media ADD COLUMN EncryptionKey TINYBLOB;

UPDATE Version SET VersionId=15;

END-OF-DATA
then
   echo "Update of Bacula MySQL tables succeeded."
else
   echo "Update of Bacula MySQL tables failed."
fi
exit 0
